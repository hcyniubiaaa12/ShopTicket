<template>
  <div class="home-page">
    <!-- È°∂ÈÉ®ÊêúÁ¥¢Ê†è -->
    <header class="mobile-header">
      <div class="location">
        <span>Âåó‰∫¨</span>
      </div>
      <div class="search-box">
        <van-search v-model="searchValue" placeholder="ÊêúÁ¥¢ÊºîÂá∫„ÄÅËâ∫‰∫∫ÊàñÂú∫È¶Ü" background="transparent" shape="round"
          @search="onSearch" />
      </div>
      <div class="qr-code">
        <van-icon name="scan" size="20" />
      </div>
    </header>

    <!-- ËΩÆÊí≠Âõæ -->
    <van-swipe class="banner-swipe" :autoplay="3000" indicator-color="#ff6a00">
      <van-swipe-item>
        <div class="banner-item" style="background-color: #ff9966;">
          <img src="https://dummyimage.com/750x300/ff9966/ffffff&text=Banner1" alt="Banner">
        </div>
      </van-swipe-item>
      <van-swipe-item>
        <div class="banner-item" style="background-color: #66ccff;">
          <img src="https://dummyimage.com/750x300/66ccff/ffffff&text=Banner2" alt="Banner">
        </div>
      </van-swipe-item>
      <van-swipe-item>
        <div class="banner-item" style="background-color: #66ff99;">
          <img src="https://dummyimage.com/750x300/66ff99/ffffff&text=Banner3" alt="Banner">
        </div>
      </van-swipe-item>
    </van-swipe>

    <!-- ÂàÜÁ±ªÂØºËà™ -->
    <div class="category-section">
      <div class="section-title">
        <h3>ÊºîÂá∫Á±ªÂûã</h3>
      </div>
      <div class="category-grid">
        <div class="category-item" v-for="(category, index) in categories" :key="index"
          @click="goToCategory(category.id)">
          <div class="category-icon" :style="{ backgroundColor: category.bgColor }">
            <van-icon :name="category.icon" :color="category.color" size="24" />
          </div>
          <span>{{ category.name }}</span>
        </div>
      </div>
    </div>

    <!-- ÁÉ≠Èó®Êé®Ëçê -->
    <div class="hot-events">
      <div class="section-title">
        <h3>ÁÉ≠Èó®Êé®Ëçê</h3>
        <router-link to='/more' class="more-link">Êü•ÁúãÊõ¥Â§ö ></router-link>
      </div>
      <div class="events-list">
        <div class="event-card" v-for="(event, index) in hotEvents" :key="index"
          @click="goToEventDetail(event.eventId,event.cityId)">
          <div class="event-image">
            <img :src="event.url">
            <div class="event-tag" v-if="event.tag">{{ event.tag }}</div>
          </div>
          <div class="event-info">
            <h3 class="event-title">{{ event.title + '-' + event.city + 'Á´ô' }}</h3>
            <p class="event-arist">{{ event.artist }}</p>
            <p class="event-time" v-if="event.firstShow != event.lastShow">
              {{
                event.firstShow + ' - ' + event.lastShow
              }}

            </p>
            <p class="event-time" v-else>{{ event.firstShow }}</p>
            <p class="event-location">{{ event.venue }}</p>

            <p class="event-price">¬•{{ event.minPrice }} Ëµ∑</p>
          </div>
        </div>
      </div>
    </div>

    <!-- Â∫ïÈÉ®ÂØºËà™ -->
    <footer class="app-footer">
      <div class="footer-container">
        <div class="footer-item" v-for="(item, index) in footerItems" :key="index"
          :class="{ active: activeFooterItem === item.id }" @click="setActiveFooterItem(item.id)">
          <div class="icon">{{ item.icon }}</div>
          <span>{{ item.name }}</span>
        </div>
      </div>
    </footer>
  </div>
</template>

<script setup>
import { ref, onMounted } from 'vue'
import { useRouter } from 'vue-router'
import { fetchAllType } from '../../public/util/type/fetchAllType'
import { fetchAllPerformance } from '../../public/util/performance/fetchPerformance'
import { fetchCity } from '../../public/util/city/fetchCity'


const router = useRouter()
const activeFooterItem = ref('home')


let city = ref([])

// Â∫ïÈÉ®ÂØºËà™È°π
const footerItems = ref([
  { id: 'home', name: 'È¶ñÈ°µ', icon: 'üè†' },
  { id: 'ticket', name: 'ÊºîÂá∫', icon: '‚ù§Ô∏è' },
  { id: 'userticket', name: 'Á•®Â§π', icon: 'üéüÔ∏è' },
  { id: 'order', name: 'ËÆ¢Âçï', icon: 'üìã' },
  { id: 'profile', name: 'ÊàëÁöÑ', icon: 'üë§' }
])

// ÂàÜÁ±ªÂØºËà™

const predefinedStyles = [
  { name: 'ÊºîÂî±‰ºö', icon: 'music', color: '#ff6a00', bgColor: '#fff0e8' },
  { name: 'Èü≥‰πêÂâß', icon: 'like', color: '#ff9966', bgColor: '#fff5f0' },
  { name: 'ËØùÂâß', icon: 'tv-o', color: '#66ccff', bgColor: '#e8f5ff' },
  { name: 'ÂÑøÁ´•Ââß', icon: 'flower-o', color: '#66ff99', bgColor: '#e8fff5' },
  { name: 'ËÑ±Âè£ÁßÄ', icon: 'underway', color: '#cc66ff', bgColor: '#f5e8ff' }
];

// ÂàõÂª∫ name -> Ê†∑Âºè ÁöÑÊò†Â∞ÑË°®
const styleMap = Object.fromEntries(
  predefinedStyles.map(item => [item.name, item])
);

// ÂìçÂ∫îÂºèÂàÜÁ±ªÊï∞ÊçÆÔºàÂ∞ÜÊù•‰ºöË¢´ÂêéÁ´ØÊï∞ÊçÆÂ°´ÂÖÖÔºâ
const categories = ref([]);

// ÁÉ≠Èó®ÊºîÂá∫ (5Êù°Êï∞ÊçÆ)
const hotEvents = ref([

])
onMounted(async () => {
  try {
    const { data } = await fetchAllType();
    const res = await fetchAllPerformance()
    const result = await fetchCity();
    if (result.data.code === 200) {


      city.value = result.data.data;

    }
    if (res.data.code === 200) {
      hotEvents.value = res.data.data.slice(0, 5); // ÂèñÂâç5Êù°ÁÉ≠Èó®ÊºîÂá∫
   



    } else {
      console.warn('Ëé∑ÂèñÊºîÂá∫Êï∞ÊçÆÂ§±Ë¥•:', res.data.message);
    }

    // Êò†Â∞ÑÂêéÁ´ØÊï∞ÊçÆ + ÂâçÁ´ØÊ†∑Âºè
    const mapped = data.data
      .filter(item => item.isDeleted === 0) // ËøáÊª§Â∑≤Âà†Èô§
      .map(item => {
        const matchedStyle = styleMap[item.name];
        if (matchedStyle) {
          return {
            id: item.id,      // ‰ΩøÁî®ÂêéÁ´ØÊï∞Â≠ó id
            name: item.name,
            icon: matchedStyle.icon,
            color: matchedStyle.color,
            bgColor: matchedStyle.bgColor
          };
        } else {
          // Â¶ÇÊûúÊ≤°ÊúâÂåπÈÖçÂà∞Ê†∑ÂºèÔºå‰ΩøÁî®ÈªòËÆ§ÂÄº
          return {
            id: item.id,
            name: item.name,
            icon: 'question-o',
            color: '#999',
            bgColor: '#f9f9f9'
          };
        }
      });

    // Êõ¥Êñ∞ categories
    categories.value = mapped;

  } catch (error) {
    console.error('Ëé∑ÂèñÂàÜÁ±ªÂ§±Ë¥•:', error);
  }
});

const onSearch = () => {
  console.log('ÊêúÁ¥¢:', searchValue.value)
}

const goToCategory = (categoryId) => {
  console.log('Êü•ÁúãÂàÜÁ±ªÊºîÂá∫:', categoryId)
  router.push(`/ticket?category=${categoryId}`)
}

const goToEventDetail = (eventId,cityId) => {
  console.log('Êü•ÁúãÊºîÂá∫ËØ¶ÊÉÖ:', eventId)

  router.push({
    path: `/event/${eventId}`,
    query: { cityId: cityId }
  })
}

const searchValue = ref('')
const setActiveFooterItem = (itemId) => {
  activeFooterItem.value = itemId
  switch (itemId) {
    case 'home':
      router.push('/')
      break
    case 'ticket':
      router.push('/ticket')
      break
    case 'userticket':
      router.push('/userticket')
      break
    case 'order':
      router.push('/order')
      break
    case 'profile':
      router.push('/profile')
      break
  }
}
</script>

<style scoped>
.home-page {
  padding-bottom: 60px;
  background-color: #f5f5f5;
}

/* È°∂ÈÉ®ÊêúÁ¥¢Ê†è */
.mobile-header {
  display: flex;
  align-items: center;
  padding: 10px 15px;
  background-color: #fff;
  position: sticky;
  top: 0;
  z-index: 100;
  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
}

.location {
  display: flex;
  align-items: center;
  font-size: 14px;
  margin-right: 10px;
}

.search-box {
  flex: 1;
}

.qr-code {
  margin-left: 10px;
}

/* ËΩÆÊí≠Âõæ */
.banner-swipe {
  height: 150px;
}

.banner-item {
  height: 100%;
  display: flex;
  align-items: center;
  justify-content: center;
}

.banner-item img {
  width: 100%;
  height: 100%;
  object-fit: cover;
}

/* ÂàÜÁ±ªÂØºËà™ */
.category-section {
  background-color: #fff;
  margin: 10px 0;
  padding: 15px;
}

.section-title {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 15px;
}

.section-title h3 {
  margin: 0;
  font-size: 16px;
  font-weight: bold;
}

.more-link {
  color: #999;
  font-size: 12px;
}

.category-grid {
  display: grid;
  grid-template-columns: repeat(5, 1fr);
  gap: 15px;
}

.category-item {
  display: flex;
  flex-direction: column;
  align-items: center;
  cursor: pointer;
}

.category-icon {
  width: 40px;
  height: 40px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  margin-bottom: 5px;
}

.category-item span {
  font-size: 12px;
  color: #333;
}

/* ÁÉ≠Èó®Êé®Ëçê */
.hot-events {
  background-color: #fff;
  padding: 15px;
  margin: 10px 0;
}

.events-list {
  display: flex;
  flex-direction: column;
  gap: 15px;
}

.event-card {
  display: flex;
  background-color: #fff;
  border-radius: 8px;
  overflow: hidden;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
  cursor: pointer;
}

.event-image {
  position: relative;
  width: 120px;
  height: 150px;
  overflow: hidden;
  flex-shrink: 0;
  display: flex;
  align-items: center;
  justify-content: center;
}

.event-image img {
  width: 100%;
  height: 100%;
  object-fit: cover;
  object-position: center;
  display: block;
}

.event-tag {
  position: absolute;
  top: 5px;
  left: 5px;
  background-color: #ff6a00;
  color: #fff;
  font-size: 10px;
  padding: 2px 5px;
  border-radius: 3px;
}

.event-info {
  flex: 1;
  padding: 8px;
  display: flex;
  flex-direction: column;
}

.event-title {
  margin: 0 0 8px 0;
  font-size: 15px;
  font-weight: bold;
  color: #333;
}

.event-time,
.event-location {
  margin: 4px 0;
  font-size: 12px;
  color: #666;
}

.event-arist {
  margin: 4px 0;
  font-size: 12px;
  color: orange
}

.event-price {
  color: #ff6a00;
  font-weight: bold;
  font-size: 15px;
  margin-bottom: auto;
}

/* Â∫ïÈÉ®ÂØºËà™Ê†è */
.app-footer {
  position: fixed;
  bottom: 0;
  left: 0;
  right: 0;
  background-color: #fff;
  box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.1);
  z-index: 100;
}

.footer-container {
  display: flex;
  max-width: 1200px;
  margin: 0 auto;
}

.footer-item {
  flex: 1;
  text-align: center;
  padding: 8px 0;
  cursor: pointer;
  font-size: 12px;
  color: #666;
}

.footer-item.active {
  color: #ff6a00;
}

.footer-item .icon {
  font-size: 18px;
  margin-bottom: 4px;
}

/* ÂìçÂ∫îÂºèËÆæËÆ° */
@media (max-width: 768px) {
  .category-grid {
    grid-template-columns: repeat(5, 1fr);
  }
}
</style>